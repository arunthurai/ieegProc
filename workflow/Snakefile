from os import listdir,makedirs,walk
from os.path import join,isdir,dirname,split,abspath,exists
import pandas as pd
from glob import glob
from shutil import copyfile
from snakemake.utils import validate
import pandas as pd 
import numpy as np

configfile: 'config/config.yml'
validate(config, "schemas/config.schema.yml")

config['dicom_dir'] = join(config['bids_dir'], 'sourcedata', 'dicoms')
config['out_dir'] = config['bids_dir']
config['clinical_event_file'] = join(config['bids_dir'], 'events.tsv')
config['participants_tsv'] = join(config['bids_dir'], 'participants_run.tsv')
config['subject_seega_scene'] = join(config['bids_dir'], 'derivatives', 'seega_scenes', 'sub-P{subject}')

if not exists(join(config['out_dir'],'logs')):
    makedirs(join(config['out_dir'],'logs'))

if config['participants_tsv']:
    df = pd.read_table(config['participants_tsv'], dtype = str, header=0)
    subjects=df.participant_id.to_list()
    if 'sub-P' in subjects[0]:
        subjects = [ s.strip('sub-P') for s in subjects]
    elif 'sub-' in subjects[0]:
        subjects = [x.split('-')[1] for x in subjects]
        print(subjects)
    else:
        subjects = [ str(s).zfill(3) for s in subjects]
else:
    subjects = [x.split('-')[1] for x in listdir(config['dicom_dir']) if isdir(join(config['dicom_dir'], x))]

#this include is for the bids() function, and 
#and any other global function declarations
include: 'rules/common.smk'

subject_id = config['subject_prefix']+'{subject}'


if config['contrast_t1']['present'] and not config['noncontrast_t1']['present'] and not config['post_ct']['present']:
    rule all:
            input:
                reg_vis = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='regqc.png',from_='subject', to='{template}',desc='{desc}',include_subject_dir=False),
                        subject=subjects, desc=['affine','SyN'],template=config['template']),
                probseg_vis = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='probseg.png', desc='atropos3seg',include_subject_dir=False),
                        subject=subjects ),
                atlas_vis = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='dseg.png',atlas='{atlas}', from_='{template}',include_subject_dir=False),
                        subject=subjects, atlas=config['atlases'],template=config['template']),
                atlas_dilated_vis = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='dseg.png',atlas='{atlas}', from_='{template}',desc='{desc}',include_subject_dir=False),
                        subject=subjects, atlas=config['atlases'],template=config['template'], desc=['dilated'],)

elif config['contrast_t1']['present'] and config['noncontrast_t1']['present'] and not config['post_ct']['present']:
     rule all:
            input:
                reg_vis = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='regqc.png',from_='subject', to='{template}',desc='{desc}',include_subject_dir=False),
                        subject=subjects, desc=['affine','SyN'],template=config['template']),
                reg_vis_noncontrast = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='regqc.png',from_='T1w', to='T1w',acq='noncontrast',desc='masked',include_subject_dir=False), 
                        subject=subjects),
                probseg_vis = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='probseg.png', desc='atropos3seg',include_subject_dir=False),
                        subject=subjects ),
                atlas_vis = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='dseg.png',atlas='{atlas}', from_='{template}',include_subject_dir=False),
                        subject=subjects, atlas=config['atlases'],template=config['template']),
                atlas_dilated_vis = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='dseg.png',atlas='{atlas}', from_='{template}',desc='{desc}',include_subject_dir=False),
                        subject=subjects, atlas=config['atlases'],template=config['template'], desc=['dilated'],),

elif config['contrast_t1']['present'] and config['noncontrast_t1']['present'] and config['post_ct']['present'] and not config['post_ct']['seega']:
     rule all:
            input:
                tar2bids = expand(join(config['out_dir'], 'logs', 'sub-' + subject_id + "_tar2bids.done"), subject=subjects),
                cleanSessions = expand(join(config['out_dir'], 'logs', 'sub-' + subject_id + "_cleanSessions.done"), subject=subjects),
                reg_vis = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='regqc.png',from_='subject', to='{template}',desc='{desc}',include_subject_dir=False),
                        subject=subjects, desc=['affine','SyN'],template=config['template']),
                reg_vis_noncontrast = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='regqc.png',from_='T1w', to='T1w',acq='contrast',include_subject_dir=False), 
                        subject=subjects),
                reg_vis_ct = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='regqc.png',from_='ct', to='T1w',desc='masked',include_subject_dir=False), 
                        subject=subjects),
                probseg_vis = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='probseg.png', desc='atropos3seg',include_subject_dir=False),
                        subject=subjects ),
                atlas_vis = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='dseg.png',atlas='{atlas}', from_='{template}',include_subject_dir=False),
                        subject=subjects, atlas=config['atlases'],template=config['template']),
                atlas_dilated_vis = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='dseg.png',atlas='{atlas}', from_='{template}',desc='{desc}',include_subject_dir=False),
                        subject=subjects, atlas=config['atlases'],template=config['template'], desc=['dilated'],),
                #electrode_vis = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='electrodevis.png',desc='{desc}',space='{template}',include_subject_dir=False),
                #        subject=subjects, desc=['affine'],template=config['template']),
                #contact_vis = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='contacts.html',desc='mask',space='ct',include_subject_dir=False),
                #        subject=subjects),
                #tsv = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),subject=subject_id,suffix='electrodes.tsv',atlas='{atlas}',desc='dilated',from_='{template}'),
                #        subject=subjects, atlas=config['atlases'],template=config['template']),
                #results = [join(config['out_dir'], 'derivatives', 'atlasreg', 'results.tar'), join(config['out_dir'], 'derivatives', 'atlasreg', 'results_tsv_only.tar')]

elif config['contrast_t1']['present'] and config['noncontrast_t1']['present'] and config['post_ct']['present'] and config['post_ct']['seega']:
     rule all:
            input:
                tar2bids = expand(join(config['out_dir'], 'logs', 'sub-' + subject_id + "_tar2bids.done"), subject=subjects),
                cleanSessions = expand(join(config['out_dir'], 'logs', 'sub-' + subject_id + "_cleanSessions.done"), subject=subjects),
                reg_vis = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='regqc.png',from_='subject', to='{template}',desc='{desc}',include_subject_dir=False),
                        subject=subjects, desc=['affine','SyN'],template=config['template']),
                reg_vis_noncontrast = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='regqc.png',from_='T1w', to='T1w',acq='contrast',include_subject_dir=False), 
                        subject=subjects),
                reg_vis_ct = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='regqc.png',from_='ct', to='T1w',desc='masked',include_subject_dir=False), 
                        subject=subjects),
                probseg_vis = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='probseg.png', desc='atropos3seg',include_subject_dir=False),
                        subject=subjects ),
                atlas_vis = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='dseg.png',atlas='{atlas}', from_='{template}',include_subject_dir=False),
                        subject=subjects, atlas=config['atlases'],template=config['template']),
                atlas_dilated_vis = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='dseg.png',atlas='{atlas}', from_='{template}',desc='{desc}',include_subject_dir=False),
                        subject=subjects, atlas=config['atlases'],template=config['template'], desc=['dilated'],),
                electrode_vis = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='electrodevis.png',desc='{desc}',space='{template}',include_subject_dir=False),
                        subject=subjects, desc=['affine'],template=config['template']),
                contact_vis = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='contacts.html',desc='mask',space='ct',include_subject_dir=False),
                        subject=subjects),
                tsv = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),subject=subject_id,suffix='electrodes.tsv',atlas='{atlas}',desc='dilated',from_='{template}'),
                        subject=subjects, atlas=config['atlases'],template=config['template']),
                #touch_fmriprep=expand(bids(root=join(config['out_dir'], 'logs'), subject=subject_id, suffix="fmriprep.done", include_subject_dir=False),subject=subjects),
                #results = [join(config['out_dir'], 'derivatives', 'atlasreg', 'results.tar'), join(config['out_dir'], 'derivatives', 'atlasreg', 'results_tsv_only.tar')]

elif config['contrast_t1']['present'] and not config['noncontrast_t1']['present'] and config['post_ct']['present'] and not config['post_ct']['seega']:
     rule all:
            input:
                reg_vis = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='regqc.png',from_='subject', to='{template}',desc='{desc}',include_subject_dir=False),
                        subject=subjects, desc=['affine','SyN'],template=config['template']),
                reg_vis_ct = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='regqc.png',from_='ct', to='T1w',desc='masked',include_subject_dir=False), 
                        subject=subjects),
                probseg_vis = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='probseg.png', desc='atropos3seg',include_subject_dir=False),
                        subject=subjects ),
                atlas_vis = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='dseg.png',atlas='{atlas}', from_='{template}',include_subject_dir=False),
                        subject=subjects, atlas=config['atlases'],template=config['template']),
                atlas_dilated_vis = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='dseg.png',atlas='{atlas}', from_='{template}',desc='{desc}',include_subject_dir=False),
                        subject=subjects, atlas=config['atlases'],template=config['template'], desc=['dilated'],)

elif config['contrast_t1']['present'] and not config['noncontrast_t1']['present'] and config['post_ct']['present'] and config['post_ct']['seega']:
     rule all:
            input:
                reg_vis = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='regqc.png',from_='subject', to='{template}',desc='{desc}',include_subject_dir=False),
                        subject=subjects, desc=['affine','SyN'],template=config['template']),
                reg_vis_ct = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='regqc.png',from_='ct', to='T1w',desc='masked',include_subject_dir=False), 
                        subject=subjects),
                probseg_vis = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='probseg.png', desc='atropos3seg',include_subject_dir=False),
                        subject=subjects ),
                atlas_vis = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='dseg.png',atlas='{atlas}', from_='{template}',include_subject_dir=False),
                        subject=subjects, atlas=config['atlases'],template=config['template']),
                atlas_dilated_vis = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='dseg.png',atlas='{atlas}', from_='{template}',desc='{desc}',include_subject_dir=False),
                        subject=subjects, atlas=config['atlases'],template=config['template'], desc=['dilated'],),
                electrode_vis = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='electrodevis.png',desc='{desc}',space='{template}',include_subject_dir=False),
                        subject=subjects, desc=['affine'],template=config['template']),
                contact_vis = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='contacts.html',desc='mask',space='ct',include_subject_dir=False),
                        subject=subjects),
                tsv = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),subject=subject_id,suffix='electrodes.tsv',atlas='{atlas}',desc='dilated',from_='{template}'),
                        subject=subjects, atlas=config['atlases'],template=config['template']),
                #results = [join(config['out_dir'], 'derivatives', 'atlasreg', 'results.tar'), join(config['out_dir'], 'derivatives', 'atlasreg', 'results_tsv_only.tar')]
    #rule all:
    #        input:
    #            reg_vis = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='regqc.png',from_='subject', to='{template}',desc='{desc}',include_subject_dir=False),
    #                    subject=subjects, desc=['affine','SyN'],template=config['template']),
    #            reg_vis_ct = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='regqc.png',from_='ct', to='T1w',desc='masked',include_subject_dir=False), 
    #                    subject=subjects),
    #            probseg_vis = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='probseg.png', desc='atropos3seg',include_subject_dir=False),
    #                    subject=subjects ),
    #            atlas_vis = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='dseg.png',atlas='{atlas}', from_='{template}',to='subject',include_subject_dir=False),
    #                    subject=subjects, atlas=config['atlases'],template=config['template']),
    #            atlas_dilated_vis = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='dseg.png',atlas='{atlas}', from_='{template}',to='subject',desc='{desc}',include_subject_dir=False),
    #                    subject=subjects, atlas=config['atlases'],template=config['template'], desc=['dilated'],),
    #            #electrode_vis = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='electrodevis.png',desc='{desc}',space='{template}',include_subject_dir=False),
    #            #        subject=subjects, desc=['affine'],template=config['template']),
    #            #contact_vis = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),prefix='sub-'+subject_id+'/qc/sub-'+subject_id,suffix='contacts.html',desc='mask',space='ct',include_subject_dir=False),
    #            #        subject=subjects),
    #            #tsv = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),subject=subject_id,suffix='electrodes.tsv',atlas='{atlas}',desc='dilated',from_='{template}'),
    #            #        subject=subjects, atlas=config['atlases'],template=config['template']),
    #            #results = [join(config['out_dir'], 'derivatives', 'atlasreg', 'results.tar'), join(config['out_dir'], 'derivatives', 'atlasreg', 'results_tsv_only.tar')]

#rule tar_results:
#    input:
#        tsv = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),subject='{subject}',suffix='electrodes.tsv',atlas='{atlas}',desc='dilated',from_='{template}'),
#                subject=subjects, atlas=config['atlases'],template=config['template']),
#        dseg_nii = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),subject='{subject}',suffix='dseg.nii.gz',desc='dilated',atlas='{atlas}',from_='{template}',reg='SyN'),
#                subject=subjects, atlas=config['atlases'],template=config['template']),
#        tissue_seg = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),subject='{subject}',suffix='probseg.nii.gz',label='{tissue}',desc='atropos3seg'),
#                            tissue=config['tissue_labels'],subject=subjects),
#        t1w = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),subject='{subject}',suffix='T1w.nii.gz',from_='atropos3seg',desc='masked'),
#                    subject=subjects)
#
#    output: join(config['out_dir'], 'derivatives', 'atlasreg', 'results.tar')
#    shell: 'tar -cvf {output} {input}'
#
#rule tar_tsv_only:
#    input:
#        tsv = expand(bids(root=join(config['out_dir'], 'derivatives', 'atlasreg'),subject='{subject}',suffix='electrodes.tsv',atlas='{atlas}',desc='dilated',from_='{template}'),
#                subject=subjects, atlas=config['atlases'],template=config['template']),
#    output: join(config['out_dir'], 'derivatives', 'atlasreg', 'results_tsv_only.tar')
#    shell: 'tar -cvf {output} {input}'

include: 'rules/dicom2bids.smk'
include: "rules/registration.smk"
include: "rules/segmentation.smk"
include: "rules/electrodes.smk"
include: "rules/visqc.smk"
#include: "rules/fmriprep.smk"
